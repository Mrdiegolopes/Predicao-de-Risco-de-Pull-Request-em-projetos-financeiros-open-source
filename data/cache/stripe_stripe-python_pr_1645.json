{"url": "https://api.github.com/repos/stripe/stripe-python/pulls/1645", "id": 2915299216, "node_id": "PR_kwDOAB3Obc6tw--Q", "html_url": "https://github.com/stripe/stripe-python/pull/1645", "diff_url": "https://github.com/stripe/stripe-python/pull/1645.diff", "patch_url": "https://github.com/stripe/stripe-python/pull/1645.patch", "issue_url": "https://api.github.com/repos/stripe/stripe-python/issues/1645", "number": 1645, "state": "closed", "locked": false, "title": "Dramatically improve performance by lazily loading most imports", "user": {"login": "xavdid-stripe", "id": 109395161, "node_id": "U_kgDOBoU82Q", "avatar_url": "https://avatars.githubusercontent.com/u/109395161?v=4", "gravatar_id": "", "url": "https://api.github.com/users/xavdid-stripe", "html_url": "https://github.com/xavdid-stripe", "followers_url": "https://api.github.com/users/xavdid-stripe/followers", "following_url": "https://api.github.com/users/xavdid-stripe/following{/other_user}", "gists_url": "https://api.github.com/users/xavdid-stripe/gists{/gist_id}", "starred_url": "https://api.github.com/users/xavdid-stripe/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/xavdid-stripe/subscriptions", "organizations_url": "https://api.github.com/users/xavdid-stripe/orgs", "repos_url": "https://api.github.com/users/xavdid-stripe/repos", "events_url": "https://api.github.com/users/xavdid-stripe/events{/privacy}", "received_events_url": "https://api.github.com/users/xavdid-stripe/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "body": "### Why?\r\n<!-- Describe why this change is being made.  Briefly include history and context, high-level what this PR does, and what the world looks like afterward. -->\r\n\r\nIn https://github.com/stripe/stripe-python/issues/1427, users flagged that importing stripe is _really_ slow. We dug into some causes in [this comment](https://github.com/stripe/stripe-python/issues/1427#issuecomment-3186372017). This PR dramatically improves import speeds and memory usage, ensuring users only \"pay\" for what they actually use.\r\n\r\nAs a result, the initial import is very fast. Subsequent operations will incur slight performance hits since we're doing imports as-needed, but the overall effect is still a dramatic increase in performance.\r\n\r\n### Stats\r\n\r\ntldr: roughly a **4x speed improvement** across the board\r\n\r\nFirst, a pure import of the module is much faster:\r\n\r\n```bash\r\n# before\r\n\r\npython -c \"print('ok'); import stripe\"  0.32s user 0.07s system 65% cpu 0.595 total\r\n\r\n# after\r\n\r\npython -c \"print('ok'); import stripe\"  0.06s user 0.02s system 88% cpu 0.087 total\r\n```\r\n\r\nEverything else also got faster as a result. For example, this script (which includes a round trip to the server):\r\n\r\n```py\r\nimport json\r\nimport stripe\r\nfrom stripe import Account\r\n# from stripe import *\r\n\r\nprint(\"should be a class:\", Account)\r\nprint(\"should be a method:\", Account.list)\r\n\r\nfrom stripe import radar\r\n\r\nprint(\"module:\", radar)\r\nprint(\"hard module:\", stripe.apps)\r\n\r\nfrom stripe import StripeClient\r\n\r\nprint(\"class:\", StripeClient)\r\nfrom stripe.params.radar import ValueListRetrieveParams\r\n\r\nprint(\"class:\", ValueListRetrieveParams)\r\nfrom stripe.params import radar as RadarParams\r\n\r\nprint(\"module:\", RadarParams)\r\nfrom stripe.params import InvoiceVoidInvoiceParams\r\n\r\nprint(\"class:\", InvoiceVoidInvoiceParams)\r\nfrom stripe.v2 import ListObject\r\n\r\nprint(\"class:\", ListObject)\r\nfrom stripe.v2 import billing\r\n\r\nprint(\"module:\", billing)\r\nfrom stripe.apps import SecretService\r\n\r\nprint(\"class:\", SecretService)\r\n\r\nfrom stripe.params.v2.billing import MeterEventStreamCreateParams\r\n\r\nprint(\"class:\", MeterEventStreamCreateParams)\r\nfrom stripe.params.v2 import billing as BillingParams\r\n\r\nprint(\"module:\", BillingParams)\r\n\r\nc = StripeClient(\"sk_test_123\")\r\nprint(\"method:\", c.v1.accounts.list)\r\nprint(\"method:\", c.v1.accounts.list)\r\n\r\nprint(\"method:\", c.invoices.list)\r\n\r\nprint(\"method:\", c.v2.core.event_destinations.list)\r\nprint(\"method:\", c.v2.billing.meter_events.create)\r\n\r\nprint(\"class:\", billing.MeterEvent)\r\n\r\nj = stripe.v2.core.EventNotification.from_json(\r\n    json.dumps(\r\n        {\r\n            \"type\": \"v1.billing.meter.error_report_triggered\",\r\n            \"id\": \"evt_123\",\r\n            \"created\": \"\",\r\n            \"related_object\": {\r\n                \"url\": \"/v1/billing/meter/mer_123\",\r\n                \"id\": \"mer_123\",\r\n                \"type\": \"meter\",\r\n            },\r\n        }\r\n    ),\r\n    c,\r\n)\r\n\r\nfrom stripe.events import (\r\n    V1BillingMeterErrorReportTriggeredEvent,\r\n    V1BillingMeterNoMeterFoundEventNotification,\r\n)\r\n\r\ncustomers = c.v1.customers.list()\r\nprint(customers.data[0])\r\n```\r\n\r\nHas improved runtime:\r\n\r\n```bash\r\n# before\r\n\r\npython stripe/main.py  0.98s user 0.54s system 47% cpu 3.186 total\r\n\r\n# after\r\n\r\npython stripe/main.py  0.24s user 0.07s system 41% cpu 0.734 total\r\n```\r\n\r\nEarly user feedback has been [very good](https://github.com/stripe/stripe-python/issues/1427#issuecomment-3408725287) and we've got good test coverage here, so I'm feeling pretty good.\r\n\r\n### What?\r\n<!--\r\nList out the key changes made in this PR, e.g.\r\n- implements the antimatter particle trace in the nitronium microfilament drive\r\n- updated tests -->\r\n\r\nFixes fall into a few big categories:\r\n\r\n1. move imports that we're just using for types into `if TYPE_CHECKING` blocks and quote them when used\r\n2. for `_service`, `__init__`, & `param` files, move all imports into a typechecking block and use  a module-level `__getattr__` ([docs](https://docs.python.org/3/reference/datamodel.html#customizing-module-attribute-access)) to dynamically resolve imports. This means we're never recursively importing everything anymore\r\n3. In `StripeClient`, lean heavily on type-only imports\r\n4. in `_v1_services.py` and `_v2_services.py`, move all types to annotations and lazily instantiate subservices as needed, instead of all at once\r\n5. Hardcode object type and event type lookups instead of getting the strings from the imported classes themselves.\r\n\r\nIn many of these cases, we generate a dict that has everything we need to import a module, then write the `__getattr__` to try and do the import when prompted. We raise `AttributeError`s when the import fails, which Python interprets on our behalf.\r\n\r\nWe use `importlib.import_module`, which is a high-level API for programmatically importing things. It caches modules just like static imports do, so subsequent dynamic imports are much faster.\r\n\r\n### See Also\r\n<!-- Include any links or additional information that help explain this change. -->\r\n\r\n- https://github.com/stripe/stripe-python/issues/1427\r\n- [DEVSDK-2709](https://go/j/DEVSDK-2709)\r\n\r\n## Changelog\r\n\r\n- move many type imports behind an `if TYPE_CHECKING` block\r\n- lazily initialize subservices\r\n- add module-level `__getattr__` functions to most `__init__.py` files", "created_at": "2025-10-14T22:53:46Z", "updated_at": "2025-10-22T17:02:56Z", "closed_at": "2025-10-17T00:33:49Z", "merged_at": "2025-10-17T00:33:48Z", "merge_commit_sha": "a31c9ec1f1a7ae4fb551fac822a937a896558e73", "assignee": null, "assignees": [], "requested_reviewers": [], "requested_teams": [], "labels": [], "milestone": null, "draft": false, "commits_url": "https://api.github.com/repos/stripe/stripe-python/pulls/1645/commits", "review_comments_url": "https://api.github.com/repos/stripe/stripe-python/pulls/1645/comments", "review_comment_url": "https://api.github.com/repos/stripe/stripe-python/pulls/comments{/number}", "comments_url": "https://api.github.com/repos/stripe/stripe-python/issues/1645/comments", "statuses_url": "https://api.github.com/repos/stripe/stripe-python/statuses/6c2b36191ffa7cbc0540e0c1fef1e2f6d3741a17", "head": {"label": "stripe:DEVSDK-2709", "ref": "DEVSDK-2709", "sha": "6c2b36191ffa7cbc0540e0c1fef1e2f6d3741a17", "user": {"login": "stripe", "id": 856813, "node_id": "MDEyOk9yZ2FuaXphdGlvbjg1NjgxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/856813?v=4", "gravatar_id": "", "url": "https://api.github.com/users/stripe", "html_url": "https://github.com/stripe", "followers_url": "https://api.github.com/users/stripe/followers", "following_url": "https://api.github.com/users/stripe/following{/other_user}", "gists_url": "https://api.github.com/users/stripe/gists{/gist_id}", "starred_url": "https://api.github.com/users/stripe/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/stripe/subscriptions", "organizations_url": "https://api.github.com/users/stripe/orgs", "repos_url": "https://api.github.com/users/stripe/repos", "events_url": "https://api.github.com/users/stripe/events{/privacy}", "received_events_url": "https://api.github.com/users/stripe/received_events", "type": "Organization", "user_view_type": "public", "site_admin": false}, "repo": {"id": 1953389, "node_id": "MDEwOlJlcG9zaXRvcnkxOTUzMzg5", "name": "stripe-python", "full_name": "stripe/stripe-python", "private": false, "owner": {"login": "stripe", "id": 856813, "node_id": "MDEyOk9yZ2FuaXphdGlvbjg1NjgxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/856813?v=4", "gravatar_id": "", "url": "https://api.github.com/users/stripe", "html_url": "https://github.com/stripe", "followers_url": "https://api.github.com/users/stripe/followers", "following_url": "https://api.github.com/users/stripe/following{/other_user}", "gists_url": "https://api.github.com/users/stripe/gists{/gist_id}", "starred_url": "https://api.github.com/users/stripe/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/stripe/subscriptions", "organizations_url": "https://api.github.com/users/stripe/orgs", "repos_url": "https://api.github.com/users/stripe/repos", "events_url": "https://api.github.com/users/stripe/events{/privacy}", "received_events_url": "https://api.github.com/users/stripe/received_events", "type": "Organization", "user_view_type": "public", "site_admin": false}, "html_url": "https://github.com/stripe/stripe-python", "description": "Python library for the Stripe API.    ", "fork": false, "url": "https://api.github.com/repos/stripe/stripe-python", "forks_url": "https://api.github.com/repos/stripe/stripe-python/forks", "keys_url": "https://api.github.com/repos/stripe/stripe-python/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/stripe/stripe-python/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/stripe/stripe-python/teams", "hooks_url": "https://api.github.com/repos/stripe/stripe-python/hooks", "issue_events_url": "https://api.github.com/repos/stripe/stripe-python/issues/events{/number}", "events_url": "https://api.github.com/repos/stripe/stripe-python/events", "assignees_url": "https://api.github.com/repos/stripe/stripe-python/assignees{/user}", "branches_url": "https://api.github.com/repos/stripe/stripe-python/branches{/branch}", "tags_url": "https://api.github.com/repos/stripe/stripe-python/tags", "blobs_url": "https://api.github.com/repos/stripe/stripe-python/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/stripe/stripe-python/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/stripe/stripe-python/git/refs{/sha}", "trees_url": "https://api.github.com/repos/stripe/stripe-python/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/stripe/stripe-python/statuses/{sha}", "languages_url": "https://api.github.com/repos/stripe/stripe-python/languages", "stargazers_url": "https://api.github.com/repos/stripe/stripe-python/stargazers", "contributors_url": "https://api.github.com/repos/stripe/stripe-python/contributors", "subscribers_url": "https://api.github.com/repos/stripe/stripe-python/subscribers", "subscription_url": "https://api.github.com/repos/stripe/stripe-python/subscription", "commits_url": "https://api.github.com/repos/stripe/stripe-python/commits{/sha}", "git_commits_url": "https://api.github.com/repos/stripe/stripe-python/git/commits{/sha}", "comments_url": "https://api.github.com/repos/stripe/stripe-python/comments{/number}", "issue_comment_url": "https://api.github.com/repos/stripe/stripe-python/issues/comments{/number}", "contents_url": "https://api.github.com/repos/stripe/stripe-python/contents/{+path}", "compare_url": "https://api.github.com/repos/stripe/stripe-python/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/stripe/stripe-python/merges", "archive_url": "https://api.github.com/repos/stripe/stripe-python/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/stripe/stripe-python/downloads", "issues_url": "https://api.github.com/repos/stripe/stripe-python/issues{/number}", "pulls_url": "https://api.github.com/repos/stripe/stripe-python/pulls{/number}", "milestones_url": "https://api.github.com/repos/stripe/stripe-python/milestones{/number}", "notifications_url": "https://api.github.com/repos/stripe/stripe-python/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/stripe/stripe-python/labels{/name}", "releases_url": "https://api.github.com/repos/stripe/stripe-python/releases{/id}", "deployments_url": "https://api.github.com/repos/stripe/stripe-python/deployments", "created_at": "2011-06-25T19:53:04Z", "updated_at": "2026-01-17T16:02:23Z", "pushed_at": "2026-01-19T00:25:01Z", "git_url": "git://github.com/stripe/stripe-python.git", "ssh_url": "org-856813@github.com:stripe/stripe-python.git", "clone_url": "https://github.com/stripe/stripe-python.git", "svn_url": "https://github.com/stripe/stripe-python", "homepage": "https://stripe.com", "size": 28946, "stargazers_count": 1941, "watchers_count": 1941, "language": "Python", "has_issues": true, "has_projects": false, "has_downloads": true, "has_wiki": true, "has_pages": false, "has_discussions": false, "forks_count": 484, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 20, "license": {"key": "mit", "name": "MIT License", "spdx_id": "MIT", "url": "https://api.github.com/licenses/mit", "node_id": "MDc6TGljZW5zZTEz"}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": ["stripe", "stripe-sdk"], "visibility": "public", "forks": 484, "open_issues": 20, "watchers": 1941, "default_branch": "master"}}, "base": {"label": "stripe:master", "ref": "master", "sha": "09248ae77b52260dddbedaa79743a3dcbee5a8a1", "user": {"login": "stripe", "id": 856813, "node_id": "MDEyOk9yZ2FuaXphdGlvbjg1NjgxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/856813?v=4", "gravatar_id": "", "url": "https://api.github.com/users/stripe", "html_url": "https://github.com/stripe", "followers_url": "https://api.github.com/users/stripe/followers", "following_url": "https://api.github.com/users/stripe/following{/other_user}", "gists_url": "https://api.github.com/users/stripe/gists{/gist_id}", "starred_url": "https://api.github.com/users/stripe/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/stripe/subscriptions", "organizations_url": "https://api.github.com/users/stripe/orgs", "repos_url": "https://api.github.com/users/stripe/repos", "events_url": "https://api.github.com/users/stripe/events{/privacy}", "received_events_url": "https://api.github.com/users/stripe/received_events", "type": "Organization", "user_view_type": "public", "site_admin": false}, "repo": {"id": 1953389, "node_id": "MDEwOlJlcG9zaXRvcnkxOTUzMzg5", "name": "stripe-python", "full_name": "stripe/stripe-python", "private": false, "owner": {"login": "stripe", "id": 856813, "node_id": "MDEyOk9yZ2FuaXphdGlvbjg1NjgxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/856813?v=4", "gravatar_id": "", "url": "https://api.github.com/users/stripe", "html_url": "https://github.com/stripe", "followers_url": "https://api.github.com/users/stripe/followers", "following_url": "https://api.github.com/users/stripe/following{/other_user}", "gists_url": "https://api.github.com/users/stripe/gists{/gist_id}", "starred_url": "https://api.github.com/users/stripe/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/stripe/subscriptions", "organizations_url": "https://api.github.com/users/stripe/orgs", "repos_url": "https://api.github.com/users/stripe/repos", "events_url": "https://api.github.com/users/stripe/events{/privacy}", "received_events_url": "https://api.github.com/users/stripe/received_events", "type": "Organization", "user_view_type": "public", "site_admin": false}, "html_url": "https://github.com/stripe/stripe-python", "description": "Python library for the Stripe API.    ", "fork": false, "url": "https://api.github.com/repos/stripe/stripe-python", "forks_url": "https://api.github.com/repos/stripe/stripe-python/forks", "keys_url": "https://api.github.com/repos/stripe/stripe-python/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/stripe/stripe-python/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/stripe/stripe-python/teams", "hooks_url": "https://api.github.com/repos/stripe/stripe-python/hooks", "issue_events_url": "https://api.github.com/repos/stripe/stripe-python/issues/events{/number}", "events_url": "https://api.github.com/repos/stripe/stripe-python/events", "assignees_url": "https://api.github.com/repos/stripe/stripe-python/assignees{/user}", "branches_url": "https://api.github.com/repos/stripe/stripe-python/branches{/branch}", "tags_url": "https://api.github.com/repos/stripe/stripe-python/tags", "blobs_url": "https://api.github.com/repos/stripe/stripe-python/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/stripe/stripe-python/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/stripe/stripe-python/git/refs{/sha}", "trees_url": "https://api.github.com/repos/stripe/stripe-python/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/stripe/stripe-python/statuses/{sha}", "languages_url": "https://api.github.com/repos/stripe/stripe-python/languages", "stargazers_url": "https://api.github.com/repos/stripe/stripe-python/stargazers", "contributors_url": "https://api.github.com/repos/stripe/stripe-python/contributors", "subscribers_url": "https://api.github.com/repos/stripe/stripe-python/subscribers", "subscription_url": "https://api.github.com/repos/stripe/stripe-python/subscription", "commits_url": "https://api.github.com/repos/stripe/stripe-python/commits{/sha}", "git_commits_url": "https://api.github.com/repos/stripe/stripe-python/git/commits{/sha}", "comments_url": "https://api.github.com/repos/stripe/stripe-python/comments{/number}", "issue_comment_url": "https://api.github.com/repos/stripe/stripe-python/issues/comments{/number}", "contents_url": "https://api.github.com/repos/stripe/stripe-python/contents/{+path}", "compare_url": "https://api.github.com/repos/stripe/stripe-python/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/stripe/stripe-python/merges", "archive_url": "https://api.github.com/repos/stripe/stripe-python/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/stripe/stripe-python/downloads", "issues_url": "https://api.github.com/repos/stripe/stripe-python/issues{/number}", "pulls_url": "https://api.github.com/repos/stripe/stripe-python/pulls{/number}", "milestones_url": "https://api.github.com/repos/stripe/stripe-python/milestones{/number}", "notifications_url": "https://api.github.com/repos/stripe/stripe-python/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/stripe/stripe-python/labels{/name}", "releases_url": "https://api.github.com/repos/stripe/stripe-python/releases{/id}", "deployments_url": "https://api.github.com/repos/stripe/stripe-python/deployments", "created_at": "2011-06-25T19:53:04Z", "updated_at": "2026-01-17T16:02:23Z", "pushed_at": "2026-01-19T00:25:01Z", "git_url": "git://github.com/stripe/stripe-python.git", "ssh_url": "org-856813@github.com:stripe/stripe-python.git", "clone_url": "https://github.com/stripe/stripe-python.git", "svn_url": "https://github.com/stripe/stripe-python", "homepage": "https://stripe.com", "size": 28946, "stargazers_count": 1941, "watchers_count": 1941, "language": "Python", "has_issues": true, "has_projects": false, "has_downloads": true, "has_wiki": true, "has_pages": false, "has_discussions": false, "forks_count": 484, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 20, "license": {"key": "mit", "name": "MIT License", "spdx_id": "MIT", "url": "https://api.github.com/licenses/mit", "node_id": "MDc6TGljZW5zZTEz"}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": ["stripe", "stripe-sdk"], "visibility": "public", "forks": 484, "open_issues": 20, "watchers": 1941, "default_branch": "master"}}, "_links": {"self": {"href": "https://api.github.com/repos/stripe/stripe-python/pulls/1645"}, "html": {"href": "https://github.com/stripe/stripe-python/pull/1645"}, "issue": {"href": "https://api.github.com/repos/stripe/stripe-python/issues/1645"}, "comments": {"href": "https://api.github.com/repos/stripe/stripe-python/issues/1645/comments"}, "review_comments": {"href": "https://api.github.com/repos/stripe/stripe-python/pulls/1645/comments"}, "review_comment": {"href": "https://api.github.com/repos/stripe/stripe-python/pulls/comments{/number}"}, "commits": {"href": "https://api.github.com/repos/stripe/stripe-python/pulls/1645/commits"}, "statuses": {"href": "https://api.github.com/repos/stripe/stripe-python/statuses/6c2b36191ffa7cbc0540e0c1fef1e2f6d3741a17"}}, "author_association": "MEMBER", "auto_merge": null, "active_lock_reason": null, "merged": true, "mergeable": null, "rebaseable": null, "mergeable_state": "unknown", "merged_by": {"login": "xavdid-stripe", "id": 109395161, "node_id": "U_kgDOBoU82Q", "avatar_url": "https://avatars.githubusercontent.com/u/109395161?v=4", "gravatar_id": "", "url": "https://api.github.com/users/xavdid-stripe", "html_url": "https://github.com/xavdid-stripe", "followers_url": "https://api.github.com/users/xavdid-stripe/followers", "following_url": "https://api.github.com/users/xavdid-stripe/following{/other_user}", "gists_url": "https://api.github.com/users/xavdid-stripe/gists{/gist_id}", "starred_url": "https://api.github.com/users/xavdid-stripe/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/xavdid-stripe/subscriptions", "organizations_url": "https://api.github.com/users/xavdid-stripe/orgs", "repos_url": "https://api.github.com/users/xavdid-stripe/repos", "events_url": "https://api.github.com/users/xavdid-stripe/events{/privacy}", "received_events_url": "https://api.github.com/users/xavdid-stripe/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "comments": 0, "review_comments": 0, "maintainer_can_modify": false, "commits": 18, "additions": 29975, "deletions": 10773, "changed_files": 249}